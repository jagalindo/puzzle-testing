package fr.inria.diverse.refm.competition.common.utils.fitness;

import java.util.Collection;

import es.us.isa.ChocoReasoner.ChocoReasoner;
import es.us.isa.ChocoReasoner.attributed.questions.ChocoProductsQuestion;
import es.us.isa.FAMA.models.featureModel.Product;
import es.us.isa.FAMA.models.variabilityModel.VariabilityModel;
import fr.inria.diverse.graph.Arc;
import fr.inria.diverse.graph.Graph;
import fr.inria.diverse.graph.Vertex;

public class FitnessMetrics {
	
	Collection<Product> FMProducts = null;

	public FitnessMetricsVO compute(VariabilityModel fm, Graph<Vertex, Arc> dependenciesGraph, String PCM) {
		FitnessMetricsVO metrics = new FitnessMetricsVO();
		int numberOfFMProducts = computeNumberOfProducts(fm);
		int numberOfPCMProducts = computeNumberOfProducts(PCM);
		
		// Computing precision
		int intersection = computeIntersectionPCMFM(fm, PCM);
		double precision = intersection / numberOfFMProducts;
		metrics.setPrecision(precision);
		
		// Computing recall
		double recall = intersection / numberOfPCMProducts;
		metrics.setRecall(recall);
		
		// Computing safety
		double safety = 0;
		for (Arc arc : dependenciesGraph.getArcs()) {
			int productsRespectingDependency = getNumberOfRespectfulProducts(arc, fm);
			safety += (productsRespectingDependency/numberOfFMProducts);
		}
		metrics.setSafety(safety);
		return metrics;
	}

	public void computeProducts(VariabilityModel fm){
		if( FMProducts == null){
			FMProducts= chocoGetProducts(fm);
		}
	}
	
	private int computeNumberOfProducts(VariabilityModel fm) {
		this.computeProducts(fm);
		return FMProducts.size();
	}
	
	private Collection<Product> chocoGetProducts(VariabilityModel fm) {
		ChocoReasoner reasoner = new ChocoReasoner();
		fm.transformTo(reasoner);
		
		ChocoProductsQuestion pq= new ChocoProductsQuestion();
		reasoner.ask(pq);
		return pq.getAllProducts();
	}

	private int computeNumberOfProducts(String PCM) {
		return PCM.split("\n").length - 1;
	}

	private int computeIntersectionPCMFM(VariabilityModel fm, String pCM) {
		// TODO Auto-generated method stub
		return 0;
	}

	

	private int getNumberOfRespectfulProducts(Arc arc, VariabilityModel fm) {
		// TODO Auto-generated method stub
		return 0;
	}

}
